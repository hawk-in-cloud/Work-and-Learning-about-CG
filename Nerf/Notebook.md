## 关于Nerf的学习笔记


### Nerf是什么？
Nerf-Neural Radiance Field（神经辐射场）算法

论文官网：https://www.matthewtancik.com/nerf

关于Nerf的一篇写的不错的文章：https://blog.csdn.net/qq_45752541/article/details/130072505

关于Nerf的网课讲解：https://www.bilibili.com/video/BV1CC411V7oq/?spm_id_from=333.337.search-card.all.click&vd_source=54ff782f01c0acb887b28fe22f172d2a

Nerf的定义：用一个MLP神经网络模型，去隐式地学习一个3D场景，最后输出能渲染出复杂环境的不同角度的视角图片。
---
### 隐式和显式的定义：  
显式存储3D信息：有明确位置信息（x,y,z坐标）（mesh、voxel、点云）  
隐式存储3D信息：无明确的xyz值，只能输出指定角度的2D图片

**在Nerf中，隐式存储表示为f( x , d ) → (density σ, color c)**

---
### MLP神经网络：
多层感知机（MLP），也叫人工神经网络（ANN，Article Neural Network），除了输入输出层，中间可存在多层隐式连接层，最简单的ANN/MLP至少拥有三层网络结构。

MLP网络结构是全连接的，也就是相邻层的每个节点都相互连接。

结构图：

![MLP原理图](./Pics/MLP原理.png)

---
### 模型输入输出结构：

输入：5维向量(x,y,z,theta,phi);   
输出：4维向量（密度，颜色（R,G,B））;   
模型：8层MLP

---
### 体渲染：   
* 引入体渲染的目的：   
Nerf将物体看作一团会发光的粒子，因此模型输入的是每个粒子的位姿   

* 体渲染：
计算光线时，将光线与物体老子的作用分为四类：   
吸收：光线经过粒子时，被粒子吸收，入射光强度减弱   
放射：光线经过粒子时，粒子本身可能发光，增强入射光强度   
外散射：光线直线传播，撞到粒子之后方向偏移，减弱入射光强度   
内散射：其他角度光线撞到粒子后方向修正，增强入射光强度   

![体渲染四种光线](./Pics/体渲染四种光线.png)   

于是出射光与入射光之间的变化量，可以表示为这四个过程的叠加：
![体渲染公式](./Pics/渲染公式.png)  


体渲染公式推导: https://yindaheng98.github.io/%E5%9B%BE%E5%BD%A2%E5%AD%A6/%E4%BD%93%E6%B8%B2%E6%9F%93.html#%E5%90%91nerf%E9%9D%A0%E6%8B%A2%EF%BC%9Anerf%E4%B8%AD%E7%9A%84%E7%A6%BB%E6%95%A3%E5%8C%96%E4%BD%93%E6%B8%B2%E6%9F%93%E8%AE%A1%E7%AE%97%E5%85%AC%E5%BC%8F

### 输入
1. 如何从图片得到粒子？   
首先从图片和相机位姿选择1024个方向，得到1024条射线    
其次每个射线选择t在[2,6]范围上均匀分布的64个点   

2. 如何输入粒子？   
首先每个图片选择1024个像素    
每个像素得到一个对应方向的射线    
每个射线选择均匀分布的64个点    
每个点集以batch的形式输入MLP模型   
即每次输入1024*64个粒子，每个粒子维度是3维（代表方向）

3. 对应来说，输出也就是这些对应粒子的密度和颜色


### 位置编码
位置编码把低频空间输入 → 映射为包含多尺度频率的信号，从而让 MLP 能学习高频内容。

$$
γ(p)=[sin(2^0πp),cos(2^0πp),sin(2^1πp),cos(2^1πp),…,sin(2^{L−1}πp),cos(2^{L−1}πp)]
$$

![MLP网络结构](./Pics/MLP网络层.png) 

初始输入网络结构（60D+3D）：
60D指的是对于空间坐标**x**(x0,y0,z0)，L取10，则对于x0,y0,z0位置坐标的三个向量，每个向量的维度为20维。    
+3D指的是初始3D位置向量。    

24D指的是对于方向向量**d**，L取4，对于方向向量的(x1-x0,y1-y0,z1-z0)，每个坐标维度为8D。   
+3D指的是初始3D方向向量（x1-x0,y1-y0,z1-z0）

前半段先输入60D的位置坐标，中断再次输入60D位置坐标，得到粒子的密度。     
最后输入24D方向坐标，输出RGB颜色。

### 体素分层采样
Nerf中将体素采样分为粗采样和细采样，先对射线上的所有点进行一次粗采样，再对有体素分布的点进一步细采样。

原理：    
Coarse model  → 找到可能有贡献的区段（粗采样）
Fine model    → 在这些区域进行密集采样（细采样）

![体素分层](./Pics/体素分层.png) 

### 优缺点
* 优点：    
1. 采用自监督方式训练，只需要多视角图像作为输入,无需依赖其他信息进行监督。
民
2. 支持可微渲染。
3. 生成新视角的细节达到相片级别。

* 缺点：
1. 与传统表达方式比，NeRF在训练和渲染方面成本较高。
2. NeRF与传统的光栅化渲染的融合应用存在一定问题（例如，不可编辑）。
3. NeRF对相机输入视角位姿和数量有一定要求。
4. 需要逐场景优化、本身没有泛化能力。